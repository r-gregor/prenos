#!/bin/bash

### ------------------------------------------------------------------------
### name:       bckpd.V3.sh
### author:     RgregoR
### date:       september 2013 / updated 20150326 / 20150414 / 20150526
### ------------------------------------------------------------------------
### Description:
### script that creates gzipped tar backup of $HOME/* files 
### and /home/forallusers/*
### 1 - checks if at destination folder  is an existing arcive and delets it
### 2 - creates the archive in the destination folder
### 
### ------------------------------------------------------------------------

# *************************************************************
# VARIABLES
# =========

echo -e "\n---"
echo "[ $(date +%Y%m%d_%H%M%S) ] - starting $0"

# source folder:
gr_FROMBIN=$HOME/majfajls/coding
# _FROMDOCS=$HOME/docs
gr_FROMFAU=/home/forallusers
# _FROMBRC=$HOME/.[a-zA-Z0-9]*
# _FROMBRC=$(find $HOME/ -maxdepth 1 -type f -iname '.*')
gr_FROMBRC="$HOME/.[hidden files]"
gr_FROMSZN=$HOME/majfajls/SEZNAMI
gr_FROMMTSS=$HOME/majfajls/METSYS-xubuntu
# gr_FROMMTSSRP=$HOME/majfajls/METSYS_Rpi-malina1

# destination folder
# !!! PAZI-  POT ZA ARHIVO !!!
gr_TOF=/home/rgregor/majfajls/bckps_all/bckp_hp_rgregor
gr_LOG=/home/rgregor/majfajls/bckps_all/bckp.log


# datestamp:
gr_DATE=$(date +%Y%m%d_%H%M%S)

# archive:
gr_CURRBIN="bckpbin_d_${gr_DATE}.tar.gz"
# _CURRDOCS="bckpdocs-en_${gr_DATE}.tar.gz"
gr_CURRFAU="bckpfau_d_${gr_DATE}.tar.gz"
gr_CURRSZN="bckpszn_d_${gr_DATE}.tar.gz"
gr_CURRBRC="bckpbrc_d_${gr_DATE}.tar"
gr_CURRDOMA="bckpdoma_d_${gr_DATE}.tar.gz"
gr_CURRMTSS="bckpmtss_d_${gr_DATE}.tar.gz"
# gr_CURRMTSSRP="bckpmtss-Rpi-d_${gr_DATE}.tar.gz"

# TEST if archive file exists:
echo
if [ "$(ls -A ${gr_TOF})" ]; then
	echo "${gr_TOF}/ is NOT empty!"
	# Ask for confirmation:
	# read -p "Press any key to REMOVE files or [ctrl+c] to quit"
	echo
	echo "Removing files from ${gr_TOF}/ ... "
	rm -v ${gr_TOF}/*
	echo "[OK]"
else
	echo "${gr_TOF}/ is empty ..."
fi

# creating an archive:
echo
echo -n "Creating archive: ${gr_TOF}/${gr_CURRBIN} ... "
# tar -czf ${gr_TOF}/${gr_CURRBIN} ${gr_FROMBIN}/*
tar -czf ${gr_TOF}/${gr_CURRBIN} -C ${HOME}/majfajls BIN
echo "[OK]"

# echo "Creating archive: ${gr_TOF}/${gr_CURRDOCS} ... "
# tar -czf ${gr_TOF}/${gr_CURRDOCS} ${gr_FROMDOCS}/*
# echo
 
echo -n "Creating archive: ${gr_TOF}/${gr_CURRFAU} ... "
# tar -czf ${gr_TOF}/${gr_CURRFAU} ${gr_FROMFAU}/*
tar -czf ${gr_TOF}/${gr_CURRFAU} -C /home forallusers
echo "[OK]"

echo -n "Creating archive: ${gr_TOF}/${gr_CURRSZN} ... "
tar -czf ${gr_TOF}/${gr_CURRSZN} -C ${HOME}/majfajls SEZNAMI
echo "[OK]"

# echo -n "Creating archive: ${gr_TOF}/${gr_CURRDOMA} ... "
# tar -czf ${gr_TOF}/${gr_CURRDOMA} -C ${HOME}/majfajls/RUT/home rgregor
# echo "[OK]"

echo -n "Creating archive: ${gr_TOF}/${gr_CURRMTSS} ... "
tar -czf ${gr_TOF}/${gr_CURRMTSS} -C ${HOME}/majfajls METSYS-xubuntu
echo "[OK]"

# echo -n "Creating archive: ${gr_TOF}/${gr_CURRMTSSRP} ... "
# tar -czf ${gr_TOF}/${gr_CURRMTSSRP} -C ${HOME}/majfajls METSYS_Rpi-malina1
# echo "[OK]"

echo -n "Creating archive: ${gr_TOF}/${gr_CURRBRC} ... "
# tar -czf ${gr_TOF}/${gr_CURRBRC} ${gr_FROMBRC}
cd $HOME && sudo find -maxdepth 1 -type f -iname "\.*" | tar -cf ${gr_TOF}/${gr_CURRBRC} -T -
cd $HOME && tar -rf ${gr_TOF}/${gr_CURRBRC} -C ${HOME} ".alseg/"
gzip ${gr_TOF}/${gr_CURRBRC}
echo "[OK]"

echo
echo "[ $(date +%Y%m%d_%H%M%S) ] - successfully backed up BIN, FAU, SZN, DOMA and BRC archives to ${gr_TOF}/" | tee -a ${gr_LOG} # append to log

